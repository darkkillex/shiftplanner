{% extends 'layout.html' %}
{% load static %}
{% block title %}Piano {{ plan.month }}/{{ plan.year }} — Shift Planner{% endblock %}

{% block content %}

<div class="row">
  <div class="col s12">
    <h5 style="margin-top:0;">Piano mensile — {{ plan.month }}/{{ plan.year }}</h5>
  </div>

  <!-- Toolbar comandi -->
  <div class="input-field col s12 m4">
    <select id="employee">
      <option value="" disabled selected>Seleziona lavoratore</option>
      {% for e in employees %}
        <option value="{{ e.id }}">{{ e.full_name }}</option>
      {% endfor %}
    </select>
    <label>Lavoratore</label>
  </div>

  <div class="input-field col s12 m3">
    <select id="shift">
      <option value="" selected>Nessun turno</option>
      {% for s in shifts %}
        <option value="{{ s.id }}">{{ s.code }} — {{ s.label }}</option>
      {% endfor %}
    </select>
    <label>Turno</label>
  </div>

  <div class="input-field col s12 m5">
    <i class="material-icons prefix">sticky_note_2</i>
    <input id="note" type="text" maxlength="255" placeholder="Nota (opzionale)">
    <label for="note">Nota</label>
  </div>


  <div class="col s12 m5" style="margin-top:22px;">
    <a id="apply" class="btn waves-effect waves-light"><i class="material-icons left">done_all</i>Applica</a>
    <a id="clear" class="btn-flat red-text text-darken-2 waves-effect"><i class="material-icons left">backspace</i>Rimuovi</a>
    <a id="notify" class="btn grey darken-1 waves-effect waves-light"><i class="material-icons left">send</i>Invia notifiche</a>
  </div>

  <!-- Filtro professioni (prima colonna) -->
  <div class="input-field col s12 m7">
    <i class="material-icons prefix">search</i>
    <input id="filter-prof" type="text" placeholder="Filtra professioni…">
    <label for="filter-prof">Filtro Professioni</label>
    <span id="filter-count" class="helper-text">Mostrate: tutte</span>
    <a id="filter-clear" class="btn-flat waves-effect" style="margin-left:8px;">
      <i class="material-icons left">close</i>Pulisci
    </a>
  </div>
</div>

<div class="spacer-8"></div>

<!-- Scrollbar superiore sincronizzata -->
<div id="grid-scroll-top" class="grid-scroll-top">
  <div id="grid-scroll-inner" class="grid-scroll-inner"></div>
</div>

<!-- Griglia -->
<div class="grid-wrapper z-depth-1">
  <table id="grid">
    <thead>
      <tr id="grid-head"><th>Professione</th></tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<!-- Modal modifica nota -->
<div id="noteModal" class="modal">
  <div class="modal-content">
    <h6>Nota cella — <span id="noteCellLabel"></span></h6>
    <div class="input-field">
      <textarea id="noteInput" class="materialize-textarea" maxlength="255" placeholder="Nota (max 255)"></textarea>
      <label for="noteInput" class="active">Nota</label>
    </div>
  </div>
  <div class="modal-footer">
    <a href="#!" class="modal-close btn-flat">Annulla</a>
    <a href="#!" id="noteSaveBtn" class="btn">Salva</a>
  </div>
</div>


{% endblock %}

{% block extra_body %}
<script>
  // Inizializza select Materialize
  document.addEventListener('DOMContentLoaded', () => {
    const elems = document.querySelectorAll('select');
    M.FormSelect.init(elems);
  });

  (async function() {
    const planId = {{ plan.id }};
    const res = await fetch(`/api/plans/${planId}/grid/`, { credentials: 'same-origin' });
    if (!res.ok) {
      M.toast({html: 'Errore caricamento griglia', classes: 'red'});
      return;
    }
    const data = await res.json();
    const days = data.days;

    // Header: numero + abbreviazione; domeniche rosse
    const head = document.getElementById('grid-head');
    const month = {{ plan.month }} - 1;   // 0-based
    const year  = {{ plan.year }};
    const weekdayFmt = new Intl.DateTimeFormat('it-IT', { weekday: 'short' });

    for (let i = 1; i <= days; i++) {
      const th = document.createElement('th');
      const date = new Date(year, month, i);
      const wd = weekdayFmt.format(date);
      th.innerHTML = `<div>${i}</div><div class="day-label">${wd}</div>`;
      if (date.getDay() === 0) th.classList.add('holiday'); // domenica
      head.appendChild(th);
    }

    // Corpo tabella
    const gridBody = document.querySelector('#grid tbody');
    data.rows.forEach(row => {
      const tr = document.createElement('tr');

      const th = document.createElement('th');
      th.textContent = row.profession;
      tr.appendChild(th);

      for (let i = 1; i <= days; i++) {
        const cellData = row[String(i)] || {};
        const td = document.createElement('td');
        td.className = 'cell';
        td.dataset.professionId = row.profession_id;
        td.dataset.day = i;

        const name  = cellData.employee_name || '';
        const shift = cellData.shift_label ? ` (${cellData.shift_label})` : '';
        const text  = name ? (name + shift) : '';

        td.dataset.employeeId = cellData.employee_id || '';
        td.dataset.notes      = cellData.notes || '';
        td.dataset.name       = name;
        td.dataset.shiftLabel = cellData.shift_label || '';

        if (cellData.has_note) {
          const tooltipText = (cellData.notes || '').replace(/"/g, '&quot;');
          td.innerHTML = `
            <span>${text}</span>
            <i class="material-icons tiny tooltipped"
               data-position="bottom"
               data-tooltip="${tooltipText}">sticky_note_2</i>
          `;
        } else {
          td.textContent = text;
        }

        tr.appendChild(td);
      }
      gridBody.appendChild(tr);
    });

    M.Tooltip.init(document.querySelectorAll('.tooltipped'));

    // Scrollbar superiore sincronizzata
    const topScroll = document.getElementById('grid-scroll-top');
    const topInner  = document.getElementById('grid-scroll-inner');
    const wrapper   = document.querySelector('.grid-wrapper');
    const table     = document.getElementById('grid');

    function syncTopWidth() {
      requestAnimationFrame(() => {
        topInner.style.width = table.scrollWidth + 'px';
      });
    }
    syncTopWidth();
    window.addEventListener('resize', syncTopWidth);

    topScroll.addEventListener('scroll', () => {
      wrapper.scrollLeft = topScroll.scrollLeft;
    });
    wrapper.addEventListener('scroll', () => {
      topScroll.scrollLeft = wrapper.scrollLeft;
    });

    // Selezione celle (click & drag)
    let isMouseDown = false;
    let selected = new Set();
    function key(p, d) { return `${p}#${d}`; }
    function mark(td, on) { td.classList.toggle('selected', !!on); }

    document.addEventListener('mousedown', e => {
      if (e.target.classList.contains('cell')) isMouseDown = true;
    });
    document.addEventListener('mouseup', () => { isMouseDown = false; });

    document.querySelectorAll('td.cell').forEach(td => {
      td.addEventListener('mousedown', e => {
        selected.clear();
        document.querySelectorAll('td.cell.selected').forEach(x => x.classList.remove('selected'));
        selected.add(key(td.dataset.professionId, td.dataset.day));
        mark(td, true);
        e.preventDefault();
      });
      td.addEventListener('mouseenter', () => {
        if (!isMouseDown) return;
        selected.add(key(td.dataset.professionId, td.dataset.day));
        mark(td, true);
      });
    });

    // CSRF helper
    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
    }
    const csrftoken = getCookie('csrftoken');

    // APPLY
    document.getElementById('apply').addEventListener('click', async () => {
      const employeeId = document.getElementById('employee').value;
      if (!employeeId) return M.toast({html: 'Seleziona un lavoratore', classes:'orange'});
      const shiftId = document.getElementById('shift').value || null;
      const note = (document.getElementById('note').value || '').trim();

      const y = {{ plan.year }};
      const m = {{ plan.month }};
      const cells = Array.from(selected).map(k => {
        const [p, d] = k.split('#');
        const dd = String(Number(d)).padStart(2, '0');
        const mm = String(m).padStart(2, '0');
        const iso = `${y}-${mm}-${dd}`;  // no UTC shift
        return { profession_id: Number(p), date: iso };
      });
      if (!cells.length) return M.toast({html: 'Seleziona almeno una cella', classes:'orange'});

      const resp = await fetch(`/api/plans/${planId}/bulk_assign/`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', ...(csrftoken ? {'X-CSRFToken': csrftoken} : {}) },
        credentials: 'same-origin',
        body: JSON.stringify({ employee_id: Number(employeeId), shift_type_id: shiftId ? Number(shiftId) : null, cells, note, })
      });
      if (!resp.ok) return M.toast({html:'Errore applicazione', classes:'red'});
      location.reload();
    });


      // --- Modal nota (Materialize) ---
      const modalElem      = document.getElementById('noteModal');
      const modal          = M.Modal.init(modalElem, { dismissible: true });
      const noteInput      = document.getElementById('noteInput');
      const noteCellLabel  = document.getElementById('noteCellLabel');
      const noteSaveBtn    = document.getElementById('noteSaveBtn');

      let currentCell = null; // td in editing

      // helper: renderizza la cella in base ai dataset
      function renderCell(td) {
        const name       = td.dataset.name || '';
        const shiftLabel = td.dataset.shiftLabel || '';
        const text       = name ? (name + (shiftLabel ? ` (${shiftLabel})` : '')) : '';
        const notes      = td.dataset.notes || '';

        if (notes) {
          const tooltipText = notes.replace(/"/g, '&quot;');
          td.innerHTML = `
            <span>${text}</span>
            <i class="material-icons tiny tooltipped"
               data-position="bottom"
               data-tooltip="${tooltipText}">sticky_note_2</i>
          `;
          const icon = td.querySelector('.tooltipped');
          if (icon) M.Tooltip.init(icon);
        } else {
          td.textContent = text;
        }
      }

      // doppio click: apri editor nota (solo se c’è un assegnato)
      document.querySelectorAll('td.cell').forEach(td => {
        td.addEventListener('dblclick', () => {
          if (!td.dataset.employeeId) {
            return M.toast({html: 'Nessuna assegnazione in questa cella. Assegna un lavoratore prima di aggiungere una nota.', classes: 'orange'});
          }
          currentCell = td;
          noteInput.value = td.dataset.notes || '';
          // forza label attiva
          const lbl = document.querySelector("label[for='noteInput']");
          if (lbl) lbl.classList.add('active');
          // Etichetta contesto: professione + giorno
          const profName = td.parentElement.querySelector('th')?.textContent || '';
          const day = td.dataset.day;
          noteCellLabel.textContent = `${profName} — Giorno ${day}`;
          modal.open();
        });
      });

      // salva nota → POST /api/plans/<id>/set_note/
      noteSaveBtn.addEventListener('click', async () => {
        if (!currentCell) return;
        const note = (noteInput.value || '').trim();

        const y = {{ plan.year }};
        const m = {{ plan.month }};
        const body = {
          profession_id: Number(currentCell.dataset.professionId),
          date: `${y}-${String(m).padStart(2,'0')}-${String(currentCell.dataset.day).padStart(2,'0')}`,
          note
        };

        const resp = await fetch(`/api/plans/${planId}/set_note/`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', ...(csrftoken ? {'X-CSRFToken': csrftoken} : {}) },
          credentials: 'same-origin',
          body: JSON.stringify(body)
        });

        if (!resp.ok) {
          return M.toast({html: 'Errore salvataggio nota', classes: 'red'});
        }

        const js = await resp.json();
        currentCell.dataset.notes = js.notes || '';
        renderCell(currentCell);

        modal.close();
        M.toast({html: js.notes ? 'Nota salvata' : 'Nota rimossa'});
      });

    // CLEAR
    document.getElementById('clear').addEventListener('click', async () => {
      if (!selected.size) return M.toast({html:'Seleziona almeno una cella', classes:'orange'});
      if (!confirm('Rimuovere le assegnazioni dalle celle selezionate?')) return;

      const y = {{ plan.year }};
      const m = {{ plan.month }};
      const cells = Array.from(selected).map(k => {
        const [p, d] = k.split('#');
        const dd = String(Number(d)).padStart(2, '0');
        const mm = String(m).padStart(2, '0');
        const iso = `${y}-${mm}-${dd}`;
        return { profession_id: Number(p), date: iso };
      });

      const resp = await fetch(`/api/plans/${planId}/bulk_clear/`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', ...(csrftoken ? {'X-CSRFToken': csrftoken} : {}) },
        credentials: 'same-origin',
        body: JSON.stringify({ cells })
      });
      if (!resp.ok) return M.toast({html:'Errore rimozione', classes:'red'});
      location.reload();
    });

    // NOTIFY
    document.getElementById('notify').addEventListener('click', async () => {
      if (!confirm('Inviare email a TUTTI i dipendenti con assegnazioni in questo piano?')) return;
      const resp = await fetch(`/api/plans/${planId}/notify/`, {
        method: 'POST',
        headers: csrftoken ? {'X-CSRFToken': csrftoken} : {},
        credentials: 'same-origin'
      });
      if (!resp.ok) return M.toast({html:'Errore invio notifiche', classes:'red'});
      const js = await resp.json();
      M.toast({html: `Email inviate: ${js.sent ?? js.prepared ?? 0}`});
    });

    // --- FILTRO PROFESSIONI (live, robusto) ---
    (function initProfessionFilterLive() {
      const input   = document.getElementById('filter-prof');
      const clearBtn= document.getElementById('filter-clear');
      const countEl = document.getElementById('filter-count');
      const tbody   = document.querySelector('#grid tbody');

      if (!input || !tbody) return;

      function normalize(s) {
        return (s || '')
          .toLowerCase()
          .normalize('NFD')                 // separa accenti
          .replace(/[\u0300-\u036f]/g, '')  // rimuove accenti
          .trim();
      }

      function applyFilter() {
        const qRaw = input.value;
        const q    = normalize(qRaw);
        const rows = tbody.rows;            // HTMLCollection live
        let shown  = 0;

        if (!q) {
          for (let i = 0; i < rows.length; i++) rows[i].style.display = '';
          if (countEl) countEl.textContent = 'Mostrate: tutte';
          return;
        }

        for (let i = 0; i < rows.length; i++) {
          const tr = rows[i];
          const firstCell = tr.cells[0];    // prima colonna (TH professione)
          const text = firstCell ? firstCell.textContent : '';
          const ok = normalize(text).includes(q);
          tr.style.display = ok ? '' : 'none';
          if (ok) shown++;
        }
        if (countEl) countEl.textContent = `Mostrate: ${shown}/${rows.length}`;
      }

      // live typing (debounce)
      let t;
      input.addEventListener('input', () => {
        clearTimeout(t);
        t = setTimeout(applyFilter, 120);
      });

      if (clearBtn) {
        clearBtn.addEventListener('click', () => {
          input.value = '';
          applyFilter();
          input.focus();
        });
      }

      // stato iniziale
      applyFilter();
    })();
  })();
</script>
{% endblock %}
